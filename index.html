<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Новые заведения СПб</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html,body{height:100%;margin:0;font-family:system-ui,sans-serif;background:#fafafa}
    body{display:flex;flex-direction:column}
    header{padding:12px 16px;background:#fff;border-bottom:1px solid #ddd;box-shadow:0 1px 3px rgba(0,0,0,.1);z-index:1000;display:flex;flex-direction:column;gap:10px}
    @media(min-width:640px){header{flex-direction:row;align-items:center;justify-content:space-between}}
    h2{margin:0;font-size:1.25rem;font-weight:600}
    .c{display:flex;flex-wrap:wrap;gap:10px;align-items:center;font-size:14px}
    select,input[type=range],button{padding:6px 10px;border:1px solid #ddd;border-radius:6px;background:#fff}
    input[type=range]{width:140px;accent-color:#e91e63}
    .v{font-weight:600;color:#e91e63;min-width:50px;text-align:center}
    button{background:#e91e63;color:#fff;border:none;cursor:pointer;font-weight:600}
    #map{flex:1;min-height:0;background:#ddd}
    footer{padding:8px;text-align:center;font-size:12px;color:#888;background:#fff;border-top:1px solid #ddd}
    #s{font-size:12px;color:#666}
    .popup-photo {max-width:250px;height:auto;margin-bottom:8px;border-radius:4px}
    .popup-link {margin-top:8px}
    .popup-link a {color:#e91e63;text-decoration:underline;font-size:12px}
  </style>
</head>
<body>
  <header>
    <h2>Новые заведения СПб</h2>
    <div class="c">
      <select id="f"><option value="все">Все</option><option value="кафе">Кафе</option><option value="бар">Бары</option><option value="ресторан">Рестораны</option><option value="кальянная">Кальянные</option></select>
      <label><input type="range" id="r" min="7" max="180" value="30"/><span class="v" id="v">30</span> дн.</label>
      <button id="b">Обновить</button>
      <span id="s">Загрузка…</span>
    </div>
  </header>
  <div id="map"></div>
  <footer>Данные из sobaka.ru, allcafe.ru, restoclub.ru. Обновление каждые 5 мин</footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([59.9386, 30.3141], 12);
    L.tileLayer('https://a.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);
    const m = L.layerGroup().addTo(map);
    const f=document.getElementById('f'),r=document.getElementById('r'),v=document.getElementById('v'),
          b=document.getElementById('b'),s=document.getElementById('s');
    let places = [];

    async function load(){
      s.textContent='Обновление…';
      try{
        const res = await fetch('places.json?t=' + Date.now());
        places = await res.json();
        s.textContent=`${places.length} заведений • ${new Date().toLocaleTimeString()}`;
      }catch(e){
        s.textContent='Офлайн-режим';
      }
      render();
    }

    function render(){
      m.clearLayers();
      const days = +r.value;
      const now = Date.now();
      const filtered = places
        .filter(p => f.value === 'все' || p.type === f.value)
        .filter(p => (now - new Date(p.isoDate)) / 86400000 <= days)
        .sort((a,b) => b.isoDate.localeCompare(a.isoDate));

      filtered.forEach(p => {
        const icon = L.divIcon({html:`<div style="background:#e91e63;color:#fff;width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:bold;box-shadow:0 2px 8px rgba(0,0,0,.4)">${p.type[0].toUpperCase()}</div>`,iconSize:[34,34]});
        const marker = L.marker([p.lat, p.lng], {icon}).addTo(m);
        const badge = (now - new Date(p.isoDate)) / 86400000 <= 7 ? '<span style="background:#ff385c;color:#fff;padding:2px 6px;border-radius:4px;font-size:10px;margin-left:4px">NEW</span>' : '';
        const photoHtml = p.photo ? `<img src="${p.photo}" class="popup-photo" alt="Интерьер" onerror="this.style.display='none'">` : '';
        const linkHtml = p.link ? `<div class="popup-link"><a href="${p.link}" target="_blank">Сайт заведения</a></div>` : '';
        marker.bindPopup(`
          <div style="font-family:system-ui;width:250px">
            <div style="font-weight:600;margin-bottom:4px">${p.name} ${badge}</div>
            <div style="font-size:13px;color:#888;margin-bottom:4px">${p.type} • ${p.address}</div>
            <div style="color:#4caf50;font-size:12px;margin-bottom:6px">Открыто: ${p.displayDate}</div>
            ${photoHtml}
            <div style="margin-bottom:6px;font-size:13px;opacity:.9">${p.desc}</div>
            ${linkHtml}
          </div>
        `);
      });

      if(filtered.length){
        const g = L.featureGroup(filtered.map(p => L.marker([p.lat, p.lng])));
        map.fitBounds(g.getBounds().pad(0.2));
      }
    }

    r.oninput = () => { v.textContent = r.value; render(); };
    f.onchange = render;
    b.onclick = load;

    load();
    setInterval(load, 300000);
    map.whenReady(() => setTimeout(render, 500));
  </script>
</body>
</html>
